<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DOBBY AGENTFIss - ANALYZE DASHBOARD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0f14;
      --card:#141a22;
      --card-2:#0f141b;
      --text:#e7edf5;
      --muted:#9aa4b2;
      --good:#27c281;
      --bad:#ff4d4f;
      --accent:#ff7a18; /* orange */
      --accent-2:#ff9b40;
      --ring:rgba(255,122,24,0.35);
      --glow:#ff7a1820;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      background: radial-gradient(1200px 800px at 20% -10%, #1a222d 0%, transparent 60%),
                  radial-gradient(1200px 800px at 120% 10%, #131a22 0%, transparent 60%),
                  linear-gradient(180deg, var(--bg), #0a0f14);
      color:var(--text);
      padding:24px;
    }
     /* Animated Background Effects */
    .bg-effects {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
      overflow: hidden;
    }

    .moving-bg-image {
      position: relative;
      width: 60%;
      height: 69%;
      top: -10%;
      left: -10%;
      background-image: url('images/redsentient.png');
      background-size: 200px 200px;
      background-position: center;
      opacity: 0.6;
      animation: moveCircuit 30s linear infinite;
    }

    @keyframes moveCircuit {
      0% { transform: translate(0, 0) rotate(0deg); }
      25% { transform: translate(-50px, -30px) rotate(90deg); }
      50% { transform: translate(-100px, -60px) rotate(180deg); }
      75% { transform: translate(-50px, -90px) rotate(270deg); }
      100% { transform: translate(0, 0) rotate(360deg); }
    }

    .light-beam {
      position: absolute;
      width: 2px;
      height: 200px;
      background: linear-gradient(180deg, transparent, var(--accent), transparent);
      border-radius: 2px;
      opacity: 0;
      animation: lightBeam 8s infinite linear;
      box-shadow: 0 0 20px var(--glow);
    }
    .light-beam:nth-child(1) { left: 10%; animation-delay: 0s; }
    .light-beam:nth-child(2) { left: 25%; animation-delay: 2s; height: 150px; }
    .light-beam:nth-child(3) { left: 40%; animation-delay: 4s; height: 180px; }
    .light-beam:nth-child(4) { left: 65%; animation-delay: 6s; height: 120px; }
    .light-beam:nth-child(5) { left: 80%; animation-delay: 1s; height: 160px; }
    .light-beam:nth-child(6) { left: 90%; animation-delay: 3s; height: 140px; }

    @keyframes lightBeam {
      0% { transform: translateY(-100vh); opacity: 0; }
      10% { opacity: 0.8; }
      90% { opacity: 0.8; }
      100% { transform: translateY(100vh); opacity: 0; }
    }

    .floating-particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: var(--accent);
      border-radius: 50%;
      opacity: 0;
      animation: floatParticle 12s infinite linear;
      box-shadow: 0 0 10px var(--glow);
    }
    .floating-particle:nth-child(7) { left: 20%; animation-delay: 0s; }
    .floating-particle:nth-child(8) { left: 50%; animation-delay: 4s; }
    .floating-particle:nth-child(9) { left: 70%; animation-delay: 8s; }

    @keyframes floatParticle {
      0% { transform: translateY(100vh) translateX(0); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(-100px) translateX(50px); opacity: 0; }
    }

    .pulse-ring {
      position: absolute;
      top: 20%;
      right: 10%;
      width: 100px;
      height: 100px;
      border: 2px solid var(--accent);
      border-radius: 50%;
      opacity: 0;
      animation: pulseRing 6s infinite ease-in-out;
    }
    .pulse-ring:nth-child(10) { animation-delay: 0s; }
    .pulse-ring:nth-child(11) { animation-delay: 2s; top: 60%; left: 5%; }

    @keyframes pulseRing {
      0% { transform: scale(0.5); opacity: 0; }
      50% { transform: scale(1.2); opacity: 0.6; }
      100% { transform: scale(2); opacity: 0; }
    }

    .grid-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        linear-gradient(rgba(255,122,24,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,122,24,0.03) 1px, transparent 1px);
      background-size: 80px 80px;
      animation: gridShift 20s infinite linear;
    }

    @keyframes gridShift {
      0% { transform: translate(0, 0); }
      100% { transform: translate(80px, 80px); }
    }  
    
    .app{
      max-width:1100px;
      margin:0 auto;
      display:grid;
      gap:18px;
    }
    .header{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .title{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:38px; height:38px; border-radius:10px;
      background: conic-gradient(from 210deg, var(--accent), var(--accent-2));
      box-shadow:0 0 0 4px rgba(255, 122, 24, 0.15), 0 6px 24px rgba(0,0,0,0.35) inset;
    }
    h1{font-size:20px; margin:0}
    .sub{color:var(--muted); font-size:13px}

    .card{
      background:linear-gradient(180deg, var(--card), var(--card-2));
      border:1px solid rgba(255,255,255,0.06);
      border-radius:14px; padding:16px;
      box-shadow: 0 12px 38px rgba(0,0,0,0.35), 0 1px 0 rgba(255,255,255,0.04) inset;
      backdrop-filter: blur(10px);
      animation: slideInUp 0.8s ease-out;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,122,24,0.1), transparent);
      animation: shimmer 3s infinite;
    }

    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    .card h2{
      margin:0 0 10px; font-size:15px; letter-spacing:.2px;
      color:#ffe1cf;
      text-shadow: 0 0 10px rgba(255,161,207,0.3);
    }
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .grow{flex:1 1 320px}
    .controls{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      background:rgba(255,255,255,0.02);
      padding:12px; border-radius:12px;
      border:1px solid rgba(255,255,255,0.05);
    }
    .input{
      position:relative; flex:1 1 360px; min-width:240px;
    }
    .input input{
      width:100%; background:#0e141b; color:var(--text);
      border:1px solid rgba(255,255,255,0.08);
      outline:none; padding:12px 12px 12px 42px; border-radius:12px; font-size:15px;
      box-shadow:0 0 0 0 transparent;
      transition:border .15s, box-shadow .15s;
    }
    .input input:focus{ border-color:var(--accent); box-shadow:0 0 0 4px var(--ring) }
    .input .hint{
      position:absolute; left:12px; top:50%; transform:translateY(-50%);
      font-size:14px; opacity:.7
    }
    .chain-select {
      position: relative;
    }
    .chain-select select {
      background: #0e141b;
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.08);
      outline: none;
      padding: 12px 32px 12px 12px;
      border-radius: 12px;
      font-size: 15px;
      min-width: 140px;
      cursor: pointer;
      transition: border .15s, box-shadow .15s;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23e7edf5'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      background-size: 16px;
    }
    .chain-select select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--ring);
    }
    .btn{
      background:linear-gradient(180deg, var(--accent), var(--accent-2));
      color:#1a0e05; border:none; border-radius:12px; padding:12px 16px;
      font-weight:700; letter-spacing:.2px; cursor:pointer;
      box-shadow:0 6px 16px rgba(255,122,24,.25);
      transition:transform .06s ease, filter .2s ease, box-shadow .2s ease;
    }
    .btn:hover{ filter:brightness(1.05); box-shadow:0 10px 22px rgba(255,122,24,.28) }
    .btn:active{ transform:translateY(1px) }
    .btn.ghost{
      background:transparent; color:var(--text); border:1px solid rgba(255,255,255,0.12)
    }

    .grid{
      display:grid; grid-template-columns: repeat(12, 1fr); gap:14px;
    }
    .col-5{ grid-column: span 5 }
    .col-7{ grid-column: span 7 }
    @media (max-width: 900px){
      .col-5, .col-7{ grid-column: 1 / -1 }
    }

    .kv{display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; padding:6px 0; border-bottom:1px dashed rgba(255,255,255,0.06)}
    .kv:last-child{border-bottom:none}
    .kv .k{ color:var(--muted); font-size:13px }
    .kv .v{ font-weight:700 }

    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px;
      background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08);
      border-radius:999px; font-size:12px; color:var(--muted);
      backdrop-filter: blur(5px);
      animation: pillGlow 4s ease-in-out infinite alternate;
    }

    @keyframes pillGlow {
      0% { box-shadow: 0 0 5px rgba(255,122,24,0.1); }
      100% { box-shadow: 0 0 15px rgba(255,122,24,0.2); }
    }

    .delta{ font-weight:700; padding:2px 8px; border-radius:999px; }
    .delta.up{ 
      color:#0e2; background:rgba(0,255,120,0.1); border:1px solid rgba(0,255,120,0.2);
      animation: deltaUp 2s ease-in-out infinite;
    }
    .delta.down{ 
      color:#f66; background:rgba(255,0,0,0.1); border:1px solid rgba(255,0,0,0.2);
      animation: deltaDown 2s ease-in-out infinite;
    }

    @keyframes deltaUp {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes deltaDown {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(0.95); }
    }

    .loading{
      display:flex; gap:10px; align-items:center; color:var(--muted);
      font-size:14px; padding:12px 0;
    }
    .dot{ 
      width:8px; height:8px; border-radius:50%; background:var(--accent); 
      animation: dotBounce 1.4s infinite ease-in-out;
      box-shadow: 0 0 10px var(--glow);
    }
    .dot:nth-child(2){ animation-delay:.2s } 
    .dot:nth-child(3){ animation-delay:.4s }
    
    @keyframes dotBounce{ 
      0%, 80%, 100%{ transform:scale(0); opacity:0.5 } 
      40%{ transform:scale(1); opacity:1 } 
    }

    .code{
      white-space:pre-wrap; background:#0c1218; border:1px solid rgba(255,255,255,0.06);
      border-radius:12px; padding:12px; 
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      color:#e8f1ff;
      backdrop-filter: blur(5px);
      position: relative;
      overflow: hidden;
    }

    .code::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      animation: codeGlow 3s ease-in-out infinite;
    }

    @keyframes codeGlow {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.8; }
    }

    .toolbar{ display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:8px }

    .toast{
      position:fixed; left:50%; bottom:24px; transform:translateX(-50%);
      background:#0f141b; border:1px solid rgba(255,255,255,0.12); color:var(--text);
      padding:10px 14px; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,0.35);
      display:none; z-index:50;
    }
    .warn{ color:#ffd7d7 }
    .muted{ color:var(--muted) }

    .typing-cursor::after {
      content: '▊';
      color: var(--accent);
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="title">
          <img src="images/redsentient.png" width="60px" height="60px">
        <div>
          <h1>Dobby AgentFI</h1>
          <div class="sub">Paste a token contract and get a crisp 24h investor snapshot + AI insights.</div>
        </div>
      </div>
      <div class="pill" id="lastUpdated">Last updated: —</div>
    </div>

    <div class="card">
      <div class="controls">
        <div class="chain-select">
          <select id="chainSelect">
            <option value="ethereum">Ethereum</option>
            <option value="bsc">BSC</option>
            <option value="polygon">Polygon</option>
            <option value="avalanche">Avalanche</option>
            <option value="arbitrum">Arbitrum</option>
            <option value="optimism">Optimism</option>
            <option value="fantom">Fantom</option>
            <option value="cronos">Cronos</option>
            <option value="solana">Solana</option>
            <option value="base">Base</option>
            <option value="blast">Blast</option>
            <option value="tron">Tron</option>
            <option value="sui">Sui</option>
            <option value="aptos">Aptos</option>
            <option value="sei">Sei</option>
            <option value="zksync">zkSync</option>
            <option value="pulsechain">PulseChain</option>
            <option value="linea">Linea</option>
            <option value="scroll">Scroll</option>
            <option value="mantle">Mantle</option>
            <option value="manta">Manta</option>
            <option value="mode">Mode</option>
            <option value="metis">Metis</option>
            <option value="moonbeam">Moonbeam</option>
            <option value="celo">Celo</option>
            <option value="kava">Kava</option>
            <option value="osmosis">Osmosis</option>
          </select>
        </div>
        <div class="input">
          <span class="hint">CA</span>
          <input id="ca" placeholder="e.g. 0x0000000000000000000000000000000000000000" />
        </div>
        <button class="btn" id="analyzeBtn">Analyze</button>
        <button class="btn ghost" id="resetBtn">Reset</button>
        <button class="btn ghost" id="copyBtn">Copy CA</button>
      </div>
        <p>Select a blockchain and paste the CA then Allow Dobby to analyze.</p>
    </div>

    <div class="grid">
      <div class="card col-5" id="tokenCard">
        <h2>Token Overview</h2>
        <div id="tokenOverview" class="muted">Select a chain, enter a contract address and click <strong>Analyze to get analysis information and Insights from Dobby</strong>.</div>
      </div>

      <div class="card col-7" id="metricsCard">
        <h2>Market Metrics (24h)</h2>
        <div id="metrics">
          <div class="loading"><span class="dot"></span><span class="dot"></span><span class="dot"></span> Waiting for input(if you have already executed "analyze" please wait)…</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Professional Insights by Dobby</h2>
      <div id="aiState" class="loading" style="display:none">
        <span class="dot"></span><span class="dot"></span><span class="dot"></span> Dobby is analyzing on-chain metrics…
      </div>
      <div id="insights" class="code muted">No insights yet.</div>
      <div class="toolbar">
        <button class="btn" id="regenBtn" disabled>Regenerate analysis from dobby</button>
        <button class="btn ghost" id="copyInsightsBtn" disabled>Copy Insights</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ====== CONFIG ======
    const FIREWORKS_API_KEY = "fw_3ZYt5vRJztdY1fXajRko5YCt";
    
    // Chain ID mapping for Dexscreener API
    const CHAIN_MAPPING = {
      'ethereum': 'ethereum',
      'bsc': 'bsc',
      'polygon': 'polygon',
      'avalanche': 'avalanche',
      'arbitrum': 'arbitrum',
      'optimism': 'optimism',
      'fantom': 'fantom',
      'cronos': 'cronos',
      'solana': 'solana',
      'base': 'base',
      'blast': 'blast',
      'tron': 'tron',
      'sui': 'sui',
      'aptos': 'aptos',
      'sei': 'sei',
      'zksync': 'zksync',
      'pulsechain': 'pulsechain',
      'linea': 'linea',
      'scroll': 'scroll',
      'mantle': 'mantle',
      'manta': 'manta',
      'mode': 'mode',
      'metis': 'metis',
      'moonbeam': 'moonbeam',
      'celo': 'celo',
      'kava': 'kava',
      'osmosis': 'osmosis'
    };

    const DEX_URL = (chain, ca) => `https://api.dexscreener.com/latest/dex/tokens/${encodeURIComponent(ca)}`;

    // ====== HELPERS ======
    const $ = (id) => document.getElementById(id);
    const fmtUSD = (n) => (n === undefined || n === null || isNaN(Number(n))) ? "—" :
      (Number(n) >= 1 ? `$${Number(n).toLocaleString(undefined,{maximumFractionDigits:2})}` :
       `$${Number(n).toExponential(2)}`);
    const fmtNum = (n) => (n === undefined || n === null || isNaN(Number(n))) ? "—" :
      Number(n).toLocaleString();
    const fmtPct = (n) => (n === undefined || n === null || isNaN(Number(n))) ? "—" :
      `${Number(n).toFixed(2)}%`;
    function toast(msg, ms=2200){ const t=$("toast"); t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none", ms); }
    function setLastUpdated(){ $("lastUpdated").textContent = "Last updated: " + new Date().toLocaleTimeString(); }

    // ====== TYPING ANIMATION ======
    function typeContent(element, content, delay = 100) {
      return new Promise((resolve) => {
        element.innerHTML = '';
        element.classList.add('typing-cursor');
        
        let index = 0;
        const type = () => {
          if (index < content.length) {
            element.innerHTML = content.substring(0, index + 1);
            index++;
            setTimeout(type, delay);
          } else {
            element.classList.remove('typing-cursor');
            resolve();
          }
        };
        type();
      });
    }

    // ====== FORMAT AND PROCESS TEXT FOR BOLD ======
    function formatTextWithBold(text) {
      // Handle markdown-style bold (**text** or *text*)
      text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      text = text.replace(/\*(.*?)\*/g, '<strong>$1</strong>');
      
      // Handle hashtag headers (convert to bold)
      text = text.replace(/^### (.*$)/gm, '<strong>$1</strong>');
      text = text.replace(/^## (.*$)/gm, '<strong>$1</strong>');
      text = text.replace(/^# (.*$)/gm, '<strong>$1</strong>');
      
      // Handle bullet points and preserve line breaks
      text = text.replace(/\n/g, '<br>');
      text = text.replace(/• /g, '• ');
      text = text.replace(/- /g, '• ');
      
      return text;
    }

    function bestPair(pairs, selectedChain){
      if(!pairs || !pairs.length) return null;
      
      // Filter pairs by selected chain if specified
      let filteredPairs = pairs;
      if(selectedChain && CHAIN_MAPPING[selectedChain]) {
        filteredPairs = pairs.filter(pair => 
          pair.chainId === CHAIN_MAPPING[selectedChain] || 
          pair.chainId === selectedChain
        );
      }
      
      // If no pairs found for the selected chain, use all pairs as fallback
      if(filteredPairs.length === 0) {
        filteredPairs = pairs;
      }
      
      // Prefer highest liquidity, then volume
      return filteredPairs.slice().sort((a,b)=>{
        const la=(a.liquidity?.usd||0), lb=(b.liquidity?.usd||0);
        if(lb!==la) return lb-la;
        const va=(a.volume?.h24||0), vb=(b.volume?.h24||0);
        return vb-va;
      })[0];
    }

    async function renderOverview(pair){
      if(!pair){ 
        $("tokenOverview").innerHTML = '<span class="warn">No token data found for this CA on the selected chain.</span>'; 
        return; 
      }
      
      const price = pair.priceUsd ? `$${Number(pair.priceUsd).toLocaleString(undefined,{maximumFractionDigits:8})}` : "—";
      const ch = pair.priceChange?.h24;
      const deltaCls = ch >= 0 ? "up" : "down";
      
      const content = `
        <div class="kv"><div class="k">Pair</div><div class="v">${pair.baseToken?.symbol || "—"} / ${pair.quoteToken?.symbol || "—"}</div></div>
        <div class="kv"><div class="k">DEX</div><div class="v">${pair.dexId || "—"}</div></div>
        <div class="kv"><div class="k">Chain</div><div class="v">${pair.chainId || pair.chain || "—"}</div></div>
        <div class="kv"><div class="k">Price</div><div class="v">${price}</div></div>
        <div class="kv"><div class="k">24h Change</div><div class="v"><span class="delta ${deltaCls}">${fmtPct(ch)}</span></div></div>
        <div class="kv"><div class="k">FDV</div><div class="v">${fmtUSD(pair.fdv)}</div></div>
        <div class="kv"><div class="k">Liquidity (USD)</div><div class="v">${fmtUSD(pair.liquidity?.usd)}</div></div>
      `;
      
      await typeContent($("tokenOverview"), content);
    }

    async function renderMetrics(pair){
      if(!pair){ 
        $("metrics").innerHTML = '<span class="warn">No 24h metrics available for the selected chain.</span>'; 
        return; 
      }
      
      const tx = pair.txns?.h24 || {};
      const content = `
        <div class="kv"><div class="k">Volume (24h)</div><div class="v">${fmtUSD(pair.volume?.h24)}</div></div>
        <div class="kv"><div class="k">Transactions (24h)</div><div class="v">${fmtNum((tx.buys||0)+(tx.sells||0))}</div></div>
        <div class="kv"><div class="k">Buys (count)</div><div class="v">${fmtNum(tx.buys)}</div></div>
        <div class="kv"><div class="k">Sells (count)</div><div class="v">${fmtNum(tx.sells)}</div></div>
        <div class="kv"><div class="k">Buy Share</div><div class="v">${
          (tx.buys||tx.sells) ? ((tx.buys/(tx.buys+tx.sells))*100).toFixed(1)+'%' : '—'
        }</div></div>
      `;
      
      await typeContent($("metrics"), content);
    }

    function setInsightsLoading(loading){
      $("aiState").style.display = loading ? "flex":"none";
      $("regenBtn").disabled = loading;
      $("copyInsightsBtn").disabled = loading;
      if(loading){ $("insights").classList.add("muted"); $("insights").textContent = "…"; }
      else { $("insights").classList.remove("muted"); }
    }

    async function getDobbyInsights(pair, ca, chain){
      setInsightsLoading(true);
      try{
        const brief = {
          ca,
          chain: chain,
          pairAddress: pair?.pairAddress || pair?.pair || pair?.address || null,
          base: pair?.baseToken?.symbol,
          quote: pair?.quoteToken?.symbol,
          chainId: pair?.chainId || pair?.chain || "",
          dex: pair?.dexId || "",
          priceUsd: pair?.priceUsd ? Number(pair.priceUsd) : null,
          change24h: pair?.priceChange?.h24 ?? null,
          volume24h: pair?.volume?.h24 ?? null,
          liquidityUsd: pair?.liquidity?.usd ?? null,
          txns24h: pair?.txns?.h24 ?? null
        };

        const res = await fetch("https://api.fireworks.ai/inference/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type":"application/json",
            "Authorization": `Bearer ${FIREWORKS_API_KEY}`
          },
          body: JSON.stringify({
            model: "accounts/sentientfoundation-serverless/models/dobby-mini-unhinged-plus-llama-3-1-8b",
            temperature: 0.4,
            max_tokens: 450,
            messages: [
              { role: "system", content: "You are Dobby, a professional crypto analyst. Provide concise, neutral, investor-grade insights for the last 24 hours. Use bullet points and bold text for important terms using **bold** syntax. Include: price trend, liquidity context, volume/txs structure (buy vs sell counts), notable risks, and a short actionable checklist. If data is missing, say so clearly. Also mention the blockchain network being analyzed." },
              { role: "user", content: `Analyze this token snapshot on ${chain} blockchain and produce a 24h investor summary:\n${JSON.stringify(brief)}` }
            ]
          })
        });

        if(!res.ok){
          const text = await res.text().catch(()=> "");
          throw new Error(`AI HTTP ${res.status}: ${text}`);
        }

        const data = await res.json();
        const rawText = data?.choices?.[0]?.message?.content
          || data?.choices?.[0]?.text
          || "No insight returned.";
        
        // Format the text with proper HTML bold tags
        const formattedText = formatTextWithBold(rawText.trim());
        
        // Type out the formatted content
        await typeContent($("insights"), formattedText);
        setInsightsLoading(false);
      }catch(err){
        console.error("Dobby insights error:", err);
        const errorMsg = `⚠️ Unable to generate insights right now.\n\nDetails: ${err.message || err}`;
        await typeContent($("insights"), errorMsg);
        setInsightsLoading(false);
      }
    }

    async function analyze(){
      const ca = $("ca").value.trim();
      const selectedChain = $("chainSelect").value;
      
      if(!ca){ toast("Please paste a contract address."); return; }

      // Reset UI state
      $("tokenOverview").innerHTML = `<div class="loading"><span class="dot"></span><span class="dot"></span><span class="dot"></span> Fetching token from ${selectedChain} via Dexscreener…</div>`;
      $("metrics").innerHTML = `<div class="loading"><span class="dot"></span><span class="dot"></span><span class="dot"></span> Loading 24h metrics…</div>`;
      $("insights").innerHTML = "No insights yet.";
      $("regenBtn").disabled = true;
      $("copyInsightsBtn").disabled = true;
      setLastUpdated();

      try{
        const r = await fetch(DEX_URL(selectedChain, ca));
        if(!r.ok){ throw new Error(`Dexscreener HTTP ${r.status}`); }
        const j = await r.json();
        const pair = bestPair(j?.pairs || [], selectedChain);
        
        // Type out the results with animation
        await renderOverview(pair);
        await renderMetrics(pair);

        if(!pair){ 
          await typeContent($("insights"), `Cannot analyze without a detected trading pair on ${selectedChain}.`);
          return; 
        }

        $("regenBtn").disabled = false;
        $("copyInsightsBtn").disabled = false;
        await getDobbyInsights(pair, ca, selectedChain);
        setLastUpdated();
      }catch(e){
        console.error(e);
        $("tokenOverview").innerHTML = `<span class="warn">Failed to load token data from ${selectedChain}.</span>`;
        $("metrics").innerHTML = `<span class="warn">Failed to load market metrics.</span>`;
        await typeContent($("insights"), "—");
        toast("Error loading data. Try again or switch chains.");
      }
    }

    // ====== EVENTS ======
    $("analyzeBtn").addEventListener("click", analyze);
    $("resetBtn").addEventListener("click", ()=>{
      $("ca").value = "";
      $("chainSelect").selectedIndex = 0; // Reset to Ethereum
      $("tokenOverview").innerHTML = 'Select a chain, enter a contract address and click <strong>Analyze</strong>.';
      $("metrics").innerHTML = `<div class="loading"><span class="dot"></span><span class="dot"></span><span class="dot"></span> Waiting for input…</div>`;
      $("insights").innerHTML = "No insights yet.";
      $("regenBtn").disabled = true;
      $("copyInsightsBtn").disabled = true;
    });
    $("copyBtn").addEventListener("click", ()=>{
      const v = $("ca").value.trim(); if(!v){ toast("Nothing to copy."); return; }
      navigator.clipboard.writeText(v).then(()=> toast("Contract copied."));
    });
    $("regenBtn").addEventListener("click", async ()=>{
      const ca = $("ca").value.trim();
      const selectedChain = $("chainSelect").value;
      if(!ca){ toast("Add a contract first."); return; }
      // Try to re-use last fetched data by calling Dexscreener quickly
      try{
        const r = await fetch(DEX_URL(selectedChain, ca));
        const j = await r.json();
        const pair = bestPair(j?.pairs || [], selectedChain);
        if(!pair){ toast(`No pair found to analyze on ${selectedChain}.`); return; }
        await getDobbyInsights(pair, ca, selectedChain);
        setLastUpdated();
      }catch(e){ toast("Could not refresh insights."); }
    });
    $("copyInsightsBtn").addEventListener("click", ()=>{
      const txt = $("insights").innerText.trim();
      if(!txt){ toast("Nothing to copy."); return; }
      navigator.clipboard.writeText(txt).then(()=> toast("Insights copied."));
    });
    $("ca").addEventListener("keydown", (e)=>{ if(e.key==="Enter") analyze(); });
  </script>
</body>
</html>
